<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Land Intelligence System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #22c55e;
            --primary-dark: #16a34a;
            --surface-50: #f8fafc;
            --surface-100: #f1f5f9;
            --surface-200: #e2e8f0;
            --surface-300: #cbd5e1;
            --surface-600: #475569;
            --surface-700: #334155;
            --surface-800: #1e293b;
            --surface-900: #0f172a;
            --emerald-50: #ecfdf5;
            --emerald-100: #d1fae5;
            --emerald-500: #10b981;
            --emerald-600: #059669;
            --amber-500: #f59e0b;
            --red-500: #ef4444;
        }

        body {
            font-family: 'Outfit', system-ui, sans-serif;
            background: var(--surface-50);
            color: var(--surface-900);
            overflow-x: hidden;
        }

        /* Header */
        header {
            background: white;
            border-bottom: 1px solid var(--surface-200);
            padding: 1rem 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        nav {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 10px;
            border: 1px solid var(--surface-200);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .logo-text h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--surface-900);
        }

        .logo-text p {
            font-size: 0.875rem;
            color: var(--surface-600);
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--surface-700);
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        .nav-links a.active {
            color: var(--primary);
        }

        /* Main Layout */
        main {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 1.5rem;
            min-height: calc(100vh - 80px);
        }

        @media (max-width: 1024px) {
            main {
                grid-template-columns: 1fr;
            }
        }

        /* Map Container */
        .map-container {
            background: white;
            border-radius: 14px;
            border: 1px solid var(--surface-200);
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
            overflow: hidden;
            position: relative;
            min-height: 500px;
        }

        #map {
            width: 100%;
            height: 100%;
            min-height: 500px;
        }

        .map-controls {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .map-btn {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid var(--surface-200);
            padding: 0.625rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--surface-900);
        }

        .search-box {
            display: flex;
            gap: 0.4rem;
        }

        .search-input {
            padding: 0.45rem 0.6rem;
            border-radius: 8px;
            border: 1px solid var(--surface-200);
            font-size: 0.85rem;
            min-width: 180px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .map-btn:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .map-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Insights Panel */
        .insights-panel {
            background: white;
            border-radius: 14px;
            border: 1px solid var(--surface-200);
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .insights-panel h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--surface-900);
            margin-bottom: 0.5rem;
        }

        .analyze-btn {
            width: 100%;
            padding: 0.875rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .analyze-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .analyze-btn.loading {
            pointer-events: none;
        }

        .save-btn {
            width: 100%;
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: white;
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .save-btn:not(:disabled):hover {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
        }

        .save-status {
            margin-top: 0.25rem;
            font-size: 0.8rem;
            color: var(--surface-600);
        }

        .save-status.success {
            color: var(--emerald-600);
        }

        .save-status.error {
            color: var(--red-500);
        }

        .report-btn {
            width: 100%;
            margin-top: 0.5rem;
            padding: 0.7rem;
            background: var(--surface-50);
            color: var(--surface-800);
            border-radius: 10px;
            border: 1px dashed var(--surface-300);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            cursor: pointer;
            text-decoration: none;
        }

        .report-btn span {
            white-space: nowrap;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Trust Score Box */
        .trust-score {
            background: var(--surface-50);
            border: 1px solid var(--surface-200);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            text-align: center;
        }

        .trust-score.low {
            border-color: var(--red-500);
        }

        .trust-score.medium {
            border-color: var(--amber-500);
        }

        .trust-score-label {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--surface-600);
            margin-bottom: 0.5rem;
        }

        .trust-score-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--surface-900);
        }

        /* Score Cards */
        .score-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .score-card {
            background: var(--surface-50);
            border: 1px solid var(--surface-200);
            border-radius: 10px;
            padding: 1rem;
        }

        .score-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .score-card-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--surface-600);
        }

        .score-card-icon {
            font-size: 1.25rem;
        }

        .score-card-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--surface-900);
            margin-bottom: 0.5rem;
        }

        .score-bar {
            height: 6px;
            background: var(--surface-200);
            border-radius: 3px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            transition: width 0.7s ease-out;
        }

        .score-bar-fill.medium {
            background: var(--amber-500);
        }

        .score-bar-fill.low {
            background: var(--red-500);
        }

        /* Risk Indicators */
        .risk-section {
            margin-top: 0.5rem;
        }

        .risk-section-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--surface-700);
            margin-bottom: 0.75rem;
        }

        .risk-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .risk-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .risk-badge.low {
            background: #ecfdf3;
            color: #15803d;
        }

        .risk-badge.medium {
            background: #fef7e5;
            color: #92400e;
        }

        .risk-badge.high {
            background: #fef2f2;
            color: #b91c1c;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--surface-600);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--surface-900);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            font-size: 0.875rem;
        }

        /* Info Card */
        .info-card {
            background: var(--surface-50);
            border: 1px solid var(--surface-200);
            border-radius: 10px;
            padding: 1rem;
        }

        .info-card-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--surface-600);
            margin-bottom: 0.5rem;
        }

        .info-card-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--surface-900);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.03);
            z-index: 800;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1rem;
        }

        .loading-overlay.active {
            display: flex;
        }

        .scan-line {
            position: absolute;
            left: 10%;
            right: 10%;
            height: 3px;
            background: linear-gradient(to right, transparent, var(--primary), transparent);
            animation: scan 1.8s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.6);
        }

        @keyframes scan {
            0%, 100% { top: 0; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Scrollbar */
        .insights-panel::-webkit-scrollbar {
            width: 6px;
        }

        .insights-panel::-webkit-scrollbar-track {
            background: var(--surface-100);
            border-radius: 3px;
        }

        .insights-panel::-webkit-scrollbar-thumb {
            background: var(--surface-300);
            border-radius: 3px;
        }

        .insights-panel::-webkit-scrollbar-thumb:hover {
            background: var(--surface-400);
        }

        /* Success Message */
        .success-message {
            background: var(--emerald-50);
            border: 1px solid var(--emerald-200);
            color: var(--emerald-700);
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            display: none;
        }

        .success-message.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="logo">
                <div class="logo-icon">üó∫Ô∏è</div>
                <div class="logo-text">
                    <h1>Land Intelligence</h1>
                    <p>AI-Powered Analysis</p>
                </div>
            </div>
            <div class="nav-links">
                <a href="landing.html">Home</a>
                <a href="dashboard.html" class="active">Dashboard</a>
                <a href="features.html">Features</a>
                <a href="about.html">About</a>
            </div>
        </nav>
    </header>

    <main>
        <div class="map-container">
            <div id="map"></div>
            <div class="map-controls">
                <div class="search-box">
                    <input class="search-input" id="searchInput" type="text" placeholder="Search place‚Ä¶" />
                    <button class="map-btn" id="searchBtn">Search</button>
                </div>
                <button class="map-btn" id="toggleSatellite">üõ∞Ô∏è Satellite</button>
                <button class="map-btn" id="toggleNDVI" style="display: none;">üåø NDVI Overlay</button>
            </div>
            <div class="loading-overlay" id="loadingOverlay">
                <div class="scan-line"></div>
            </div>
        </div>

        <div class="insights-panel">
            <h2>Insights</h2>
            
            <button class="analyze-btn" id="analyzeBtn" disabled>
                <span>Analyze Land</span>
            </button>

            <!-- New explicit save button for Supabase -->
            <button class="save-btn" id="saveBtn" disabled>
                <span>Save to Supabase</span>
            </button>
            <div class="save-status" id="saveStatus"></div>

            <a href="#" class="report-btn" id="reportBtn" style="display:none;">
                <span>View detailed land report</span>
            </a>

            <div class="success-message" id="successMessage">
                ‚úì Analysis complete!
            </div>

            <div id="insightsContent">
                <div class="empty-state">
                    <div class="empty-state-icon">üó∫Ô∏è</div>
                    <h3>Select land on the map</h3>
                    <p>Draw a polygon to analyze and get AI-powered insights</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Supabase (for saving analysis results) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script>
        // Supabase configuration - using your project credentials
        const SUPABASE_URL = 'https://eacqzsrymnicqpnaqifr.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_g21sW41IlW1zgMFPJp-yYA_Fgck0NkA';

        // OpenWeather configuration (used for weather-based risk scores)
        const OPENWEATHER_API_KEY = '29b92f286d29b8f145e27a9308424e5f';

        const supabaseClient = window.supabase
            ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
            : null;

        function buildBoundaryGeoJSON(land) {
            if (!land || !Array.isArray(land.coordinates) || land.coordinates.length === 0) {
                return null;
            }

            // GeoJSON expects [lng, lat]
            const ring = land.coordinates.map(([lat, lon]) => [lon, lat]);
            // Ensure polygon is closed (first == last)
            if (ring.length > 0) {
                const first = ring[0];
                const last = ring[ring.length - 1];
                if (first[0] !== last[0] || first[1] !== last[1]) {
                    ring.push([...first]);
                }
            }

            return {
                type: 'Polygon',
                coordinates: [ring],
            };
        }

        function deriveSoilType(soilHealth) {
            const v = Number(soilHealth || 0);
            if (v >= 80) return 'High fertility';
            if (v >= 60) return 'Moderate fertility';
            if (v >= 40) return 'Low fertility';
            return 'Poor / degraded';
        }

        function deriveCropRecommendation(data) {
            const ndvi = Number((data.ndvi_score ?? 0) * 100);
            const soil = Number(data.soil_health ?? 0);

            if (ndvi > 70 && soil > 75) {
                return 'Ideal for high-value crops (e.g. vegetables, fruits)';
            }
            if (ndvi > 50 && soil > 60) {
                return 'Suitable for cereals and pulses (e.g. wheat, maize, lentils)';
            }
            if (soil > 40) {
                return 'Consider drought-resilient crops (e.g. millets, sorghum)';
            }
            return 'Recommend soil restoration / cover crops before intensive cultivation';
        }

        // Fetch weather from OpenWeather for the selected land centroid
        async function fetchWeather(lat, lon) {
            if (!OPENWEATHER_API_KEY) return null;
            const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=metric`;
            try {
                const res = await fetch(url);
                if (!res.ok) {
                    const text = await res.text().catch(() => '');
                    console.error('OpenWeather error status:', res.status, text);
                    return null;
                }
                const data = await res.json();
                return data;
            } catch (err) {
                console.error('OpenWeather fetch error:', err);
                return null;
            }
        }

        // Derive simple flood/drought risk from OpenWeather forecast
        function deriveRisksFromWeather(weather) {
            if (!weather || !Array.isArray(weather.list) || weather.list.length === 0) {
                return { flood_risk: null, drought_risk: null, weather_summary: null };
            }

            // Look at first ~24h (8 x 3h entries)
            const window = weather.list.slice(0, 8);
            let totalRain = 0;
            let maxTemp = -Infinity;
            let minHumidity = Infinity;

            window.forEach(entry => {
                const rain3h = entry.rain && entry.rain['3h'] ? entry.rain['3h'] : 0;
                totalRain += rain3h;
                maxTemp = Math.max(maxTemp, entry.main?.temp ?? maxTemp);
                minHumidity = Math.min(minHumidity, entry.main?.humidity ?? minHumidity);
            });

            // Flood risk based on rain amount
            let flood_risk;
            if (totalRain >= 40) flood_risk = `High (${totalRain.toFixed(1)} mm/24h)`;
            else if (totalRain >= 15) flood_risk = `Medium (${totalRain.toFixed(1)} mm/24h)`;
            else flood_risk = `Low (${totalRain.toFixed(1)} mm/24h)`;

            // Drought risk based on low rain + high temp + low humidity
            let drought_risk;
            if (totalRain < 2 && maxTemp >= 32 && minHumidity <= 40) {
                drought_risk = 'High (hot & very dry)';
            } else if (totalRain < 5 && maxTemp >= 28) {
                drought_risk = 'Medium (warm & limited rain)';
            } else {
                drought_risk = 'Low (sufficient moisture)';
            }

            const first = weather.list[0];
            const summary = first
                ? `${first.weather?.[0]?.description ?? 'N/A'}, ${first.main?.temp?.toFixed?.(1) ?? '‚Äì'}¬∞C`
                : null;

            return {
                flood_risk,
                drought_risk,
                weather_summary: summary,
            };
        }

        async function saveAnalysisToSupabase(land, data) {
            // Skip if Supabase is not configured yet
            if (
                !supabaseClient ||
                !SUPABASE_URL ||
                SUPABASE_URL.startsWith('https://YOUR-PROJECT-REF')
            ) {
                return;
            }

            try {
                const boundaryGeoJSON = buildBoundaryGeoJSON(land);

                const { error } = await supabaseClient.from('land_records').insert({
                    // owner_id and id can be generated / filled later if needed
                    boundary_geojson: boundaryGeoJSON,
                    land_use_type: data.land_type,
                    soil_type: deriveSoilType(data.soil_health),
                    crop_recommendation: deriveCropRecommendation(data),
                });

                if (error) {
                    console.error('Supabase insert error:', error);
                    throw error;
                }
            } catch (err) {
                console.error('Supabase unexpected error:', err);
                throw err;
            }
        }

        // Map initialization
        const map = L.map('map').setView([20.5937, 78.9629], 5);

        // Tile layers
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        });

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; Esri'
        });

        streetLayer.addTo(map);
        let currentLayer = streetLayer;
        let isSatellite = false;
        let ndviOverlay = null;

        // Draw control
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        const drawControl = new L.Control.Draw({
            position: 'topright',
            draw: {
                polygon: {
                    allowIntersection: false,
                    shapeOptions: {
                        color: '#22c55e',
                        fillColor: '#22c55e',
                        fillOpacity: 0.3
                    },
                    showArea: true,
                    metric: true
                },
                polyline: false,
                circle: false,
                rectangle: false,
                marker: false,
                circlemarker: false
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });

        map.addControl(drawControl);

        let selectedLand = null;
        let lastAnalysis = null;

        // Handle polygon creation
        map.on(L.Draw.Event.CREATED, (e) => {
            const layer = e.layer;
            drawnItems.clearLayers();
            drawnItems.addLayer(layer);

            const latlngs = layer.getLatLngs()[0];
            let sumLat = 0, sumLng = 0;
            latlngs.forEach(ll => {
                sumLat += ll.lat;
                sumLng += ll.lng;
            });

            selectedLand = {
                coordinates: latlngs.map(ll => [ll.lat, ll.lng]),
                centroid: {
                    lat: sumLat / latlngs.length,
                    lon: sumLng / latlngs.length
                }
            };

            document.getElementById('analyzeBtn').disabled = false;
            updateEmptyState(false);
        });

        // Handle polygon deletion
        map.on(L.Draw.Event.DELETED, () => {
            selectedLand = null;
            document.getElementById('analyzeBtn').disabled = true;
            const saveBtn = document.getElementById('saveBtn');
            const saveStatus = document.getElementById('saveStatus');
            if (saveBtn) saveBtn.disabled = true;
            lastAnalysis = null;
            if (saveStatus) {
                saveStatus.textContent = '';
                saveStatus.className = 'save-status';
            }
            updateEmptyState(true);
            clearInsights();
        });

        // Simple place search using Nominatim (OpenStreetMap)
        async function searchLocation(query) {
            if (!query) return;
            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
                const res = await fetch(url, {
                    headers: {
                        'Accept-Language': 'en',
                    }
                });
                const results = await res.json();
                if (Array.isArray(results) && results.length > 0) {
                    const { lat, lon } = results[0];
                    map.setView([parseFloat(lat), parseFloat(lon)], 13);
                }
            } catch (e) {
                console.error('Search error:', e);
            }
        }

        // Layer toggle
        document.getElementById('toggleSatellite').addEventListener('click', () => {
            isSatellite = !isSatellite;
            map.removeLayer(currentLayer);
            
            if (isSatellite) {
                currentLayer = satelliteLayer;
                document.getElementById('toggleNDVI').style.display = 'block';
            } else {
                currentLayer = streetLayer;
                document.getElementById('toggleNDVI').style.display = 'none';
                if (ndviOverlay) {
                    map.removeLayer(ndviOverlay);
                    ndviOverlay = null;
                }
            }
            
            currentLayer.addTo(map);
            document.getElementById('toggleSatellite').textContent = isSatellite ? 'üó∫Ô∏è Street' : 'üõ∞Ô∏è Satellite';
        });

        // NDVI toggle
        document.getElementById('toggleNDVI').addEventListener('click', (e) => {
            if (ndviOverlay) {
                map.removeLayer(ndviOverlay);
                ndviOverlay = null;
                e.target.classList.remove('active');
            } else {
                ndviOverlay = L.rectangle([[90, -180], [-90, 180]], {
                    color: '#22c55e',
                    fillColor: '#22c55e',
                    fillOpacity: 0.2,
                    interactive: false
                }).addTo(map);
                e.target.classList.add('active');
            }
        });

        // Search events
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        if (searchBtn && searchInput) {
            searchBtn.addEventListener('click', () => {
                searchLocation(searchInput.value.trim());
            });
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchLocation(searchInput.value.trim());
                }
            });
        }

        // Mock AI template data (land use / soil / trust)
        const mockResponses = [
            {
                land_type: 'Agricultural - Crop Land',
                ndvi_score: 0.72,
                soil_health: 78,
                change_detection: 'Stable vegetation cover over past 6 months',
                trust_score: 87
            },
            {
                land_type: 'Mixed Use - Rural',
                ndvi_score: 0.58,
                soil_health: 65,
                change_detection: 'Moderate forest clearance detected in recent months',
                trust_score: 72
            },
            {
                land_type: 'Forest / Vegetation',
                ndvi_score: 0.89,
                soil_health: 91,
                change_detection: 'No significant change in canopy cover',
                trust_score: 94
            }
        ];

        // Analyze button
        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            if (!selectedLand) return;

            const btn = document.getElementById('analyzeBtn');
            const overlay = document.getElementById('loadingOverlay');
            const saveBtn = document.getElementById('saveBtn');
            const saveStatus = document.getElementById('saveStatus');
            const reportBtn = document.getElementById('reportBtn');
            
            btn.disabled = true;
            btn.classList.add('loading');
            btn.innerHTML = '<div class="spinner"></div><span>Analyzing...</span>';
            overlay.classList.add('active');

            // Simulate AI + weather calls
            await new Promise(resolve => setTimeout(resolve, 800));

            // 1) Get base AI-style template
            let response = { ...mockResponses[Math.floor(Math.random() * mockResponses.length)] };

            // 2) Fetch weather & derive risk scores
            const weather = await fetchWeather(selectedLand.centroid.lat, selectedLand.centroid.lon);
            const { flood_risk, drought_risk, weather_summary } = deriveRisksFromWeather(weather);

            response = {
                ...response,
                flood_risk: flood_risk ?? 'Low (n/a)',
                drought_risk: drought_risk ?? 'Low (n/a)',
                weather_summary: weather_summary ?? 'No data',
            };

            displayInsights(response);
            lastAnalysis = response;

            if (saveBtn) {
                saveBtn.disabled = false;
            }
            if (reportBtn) {
                reportBtn.style.display = 'flex';
                const url = new URL(window.location.origin + window.location.pathname.replace('dashboard.html', 'report.html'));
                url.searchParams.set('lat', selectedLand.centroid.lat);
                url.searchParams.set('lon', selectedLand.centroid.lon);
                reportBtn.href = url.toString();
            }
            if (saveStatus) {
                saveStatus.textContent = '';
                saveStatus.className = 'save-status';
            }

            btn.disabled = false;
            btn.classList.remove('loading');
            btn.innerHTML = '<span>Analyze Land</span>';
            overlay.classList.remove('active');

            // Show success message
            const successMsg = document.getElementById('successMessage');
            successMsg.classList.add('active');
            setTimeout(() => successMsg.classList.remove('active'), 3000);
        });

        // Save button
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const saveBtn = document.getElementById('saveBtn');
            const saveStatus = document.getElementById('saveStatus');
            if (!selectedLand || !lastAnalysis || !saveBtn) return;

            saveBtn.disabled = true;
            if (saveStatus) {
                saveStatus.textContent = 'Saving to Supabase...';
                saveStatus.className = 'save-status';
            }

            try {
                await saveAnalysisToSupabase(selectedLand, lastAnalysis);
                if (saveStatus) {
                    saveStatus.textContent = 'Saved to Supabase.';
                    saveStatus.className = 'save-status success';
                }
            } catch (e) {
                if (saveStatus) {
                    saveStatus.textContent = 'Failed to save. Check console.';
                    saveStatus.className = 'save-status error';
                }
            } finally {
                saveBtn.disabled = false;
            }
        });

        function updateEmptyState(show) {
            const content = document.getElementById('insightsContent');
            if (show) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üó∫Ô∏è</div>
                        <h3>Select land on the map</h3>
                        <p>Draw a polygon to analyze and get AI-powered insights</p>
                    </div>
                `;
            }
        }

        function clearInsights() {
            updateEmptyState(true);
        }

        function getRiskLevel(risk) {
            const str = String(risk).toLowerCase();
            if (str.includes('high')) return 'high';
            if (str.includes('medium') || str.includes('moderate')) return 'medium';
            return 'low';
        }

        function displayInsights(data) {
            const content = document.getElementById('insightsContent');
            
            const trustScoreClass = data.trust_score >= 70 ? '' : data.trust_score >= 40 ? 'medium' : 'low';
            const ndviPercent = (data.ndvi_score * 100).toFixed(1);
            const floodRisk = getRiskLevel(data.flood_risk);
            const droughtRisk = getRiskLevel(data.drought_risk);
            
            const soilHealthClass = data.soil_health >= 70 ? '' : data.soil_health >= 40 ? 'medium' : 'low';
            const ndviClass = data.ndvi_score >= 0.7 ? '' : data.ndvi_score >= 0.4 ? 'medium' : 'low';

            content.innerHTML = `
                <div class="trust-score ${trustScoreClass}">
                    <div class="trust-score-label">Land Trust Score</div>
                    <div class="trust-score-value">${data.trust_score}%</div>
                </div>

                <div class="info-card">
                    <div class="info-card-label">Land Type</div>
                    <div class="info-card-value">${data.land_type}</div>
                </div>

                <div class="score-grid">
                    <div class="score-card">
                        <div class="score-card-header">
                            <span class="score-card-label">NDVI Score</span>
                            <span class="score-card-icon">üåø</span>
                        </div>
                        <div class="score-card-value">${ndviPercent}%</div>
                        <div class="score-bar">
                            <div class="score-bar-fill ${ndviClass}" style="width: ${ndviPercent}%"></div>
                        </div>
                    </div>

                    <div class="score-card">
                        <div class="score-card-header">
                            <span class="score-card-label">Soil Health</span>
                            <span class="score-card-icon">ü™¥</span>
                        </div>
                        <div class="score-card-value">${data.soil_health}%</div>
                        <div class="score-bar">
                            <div class="score-bar-fill ${soilHealthClass}" style="width: ${data.soil_health}%"></div>
                        </div>
                    </div>
                </div>

                <div class="risk-section">
                    <div class="risk-section-label">Risk Assessment</div>
                    <div class="risk-badges">
                        <span class="risk-badge ${floodRisk}">‚ö†Ô∏è Flood: ${data.flood_risk}</span>
                        <span class="risk-badge ${droughtRisk}">üåµ Drought: ${data.drought_risk}</span>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-card-label">Weather</div>
                    <div class="info-card-value">${data.weather_summary || 'No recent forecast data'}</div>
                </div>

                <div class="info-card">
                    <div class="info-card-label">Change Detection</div>
                    <div class="info-card-value">${data.change_detection}</div>
                </div>
            `;
        }
    </script>
</body>
</html>
